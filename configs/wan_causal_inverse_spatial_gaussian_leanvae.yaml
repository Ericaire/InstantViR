# Config for InstantViR inverse problem training - Spatial Gaussian Blur with LeanVAE
model_name: wan
generator_name: causal_wan
# Start from pretrained checkpoint
# generator_ckpt: "./outputs/wan_causal_inverse_spatial_gaussian_leanvae/2025-10-27-13-19-10.809045_seed7784522/checkpoint_model_001200/model.pt"
# generator_ckpt: "./outputs/wan_causal_inverse_spatial_gaussian_leanvae/2025-10-29-16-41-54.027390_seed2409006/checkpoint_model_000400/model.pt"
# generator_ckpt: "./outputs/wan_causal_inverse_spatial_gaussian_leanvae/2025-10-30-01-55-24.616536_seed4260017/checkpoint_model_000400/model.pt"

# generator_ckpt: "./outputs/wan_causal_inverse_spatial_gaussian/2025-08-24-18-25-31.668144_seed4029389/checkpoint_model_001500/model.pt"
generator_ckpt: "./outputs/wan_causal_inverse_spatial_gaussian_leanvae/2025-11-04-09-48-55.965463_seed7552758/checkpoint_model_002200/model.pt"

generator_fsdp_wrap_strategy: size
real_score_fsdp_wrap_strategy: size
fake_score_fsdp_wrap_strategy: size
text_encoder_fsdp_wrap_strategy: size

generator_grad:
  model: true
real_score_grad:
  model: false
fake_score_grad:
  model: true

denoising_step_list:
- 1000
- 757
- 522
- 0
num_train_timestep: 1000
timestep_shift: 8.0
real_guidance_scale: 3.5

generator_task: causal_video
real_task_type: bidirectional_video
fake_task_type: bidirectional_video
denoising_loss_type: flow

mixed_precision: true
seed: 0

wandb_host: WANDB_HOST
wandb_key: WANDB_KEY
wandb_entity: tyin
wandb_project: instantvir_inverse
wandb_name: wan_causal_inverse_spatial_gaussian_leanvae

sharding_strategy: no_shard
optimizer: adamw
lr: 5.0e-05
beta1: 0.9
beta2: 0.999

# dataset - using LeanVAE preprocessed spatial gaussian LMDB
data_path: "data/spatial_gaussian_leanvae_merged.lmdb"
batch_size: 4
log_iters: 200
negative_prompt: 色调艳丽，过曝，静态，细节模糊不清，字幕，风格，作品，画作，画面，静止，整体发灰，最差质量，低质量，JPEG压缩残留，丑陋的，残缺的，多余的手指，画得不好的手部，画得不好的脸部，畸形的，毁容的，形态畸形的肢体，手指融合，静止不动的画面，杂乱的背景，三条腿，背景人很多，倒着走

dfake_gen_update_ratio: 5
image_or_video_shape:
- 1
- 21  # LeanVAE native temporal compression: 81 pixel frames -> 21 latent frames
- 16  # LeanVAE latent channels
- 60
- 104

output_path: ./outputs/wan_causal_inverse_spatial_gaussian_leanvae

# trainer
distillation_loss: dmd
gradient_checkpointing: true
backward_simulation: false
num_frame_per_block: 3
warp_denoising_step: false
compile_model: false

# inverse problem settings - Spatial Gaussian Blur
inverse_problem_type: spatial_blur
blur_kernel_size: 61
blur_sigma: 3.0
noise_level: 0.0
use_predegraded_dataset: true

# losses
measurement_consistency_weight: 1.0
# measurement_consistency_weight: 0.5

use_gt_consistency: true
# use_gt_consistency: false

gt_consistency_space: latent
# dmd_warmup_steps: 400
dmd_warmup_steps: 1000
# dmd_warmup_steps: 4000
# dmd_warmup_steps: 0  

gradient_clip_norm: 1.0
ema_decay: 0.999

# VAE settings - LeanVAE
vae_type: leanvae
leanvae_ckpt_path: LeanVAE-master/LeanVAE-16ch_ckpt/LeanVAE-dim16.ckpt

disable_latent_conversion: true  # 启用latent转换（方案1的核心）

